#!/usr/bin/env ruby

require 'spaceape-cfn'
require 'gli'

include GLI::App

program_desc "Spaceape Cloudformation Tool"

desc "Generate the scaffold of a stack, including cfndsl template and config files"
long_desc %{Templates can be found in the skel/ directory.
For the common cases you can specify as_group_with_elb or as_group_no_elb}
command :scaffold do |c|
  c.flag [:game]
  c.flag [:config_template]
  c.flag 
  c.action do |globals, options, args|
    help_now!("Wrong number of arguments for scaffold") if args.length == 0
    s = Spaceape::Cloudformation::Generator.new(*args[0..1])
    s.scaffold(options, *args[2..-1])
  end
end

desc "Generate cloudformation JSON"
long_desc "Generate JSON from CFNDSL template and config files."
command :generate do |c|
  c.action do |globals, options, args|
    help_now!("Wrong number of arguments for generate") unless args.length == 2
    s = Spaceape::Cloudformation::Generator.new(*args)
    s.generate
  end
end

desc "Upload JSON template to AWS"
long_desc "Create a stack from pre-generated JSON template"
command :build do |c|
  c.flag [:policy]
  c.flag [:stackname], :required => true
  c.switch [:y]
  c.action do |globals, options, args|
    help_now!("Wrong number of arguments for build") unless args.length == 2
    s = Spaceape::Cloudformation::Uploader.new(*args)
    s.create_stack(options)
  end
end

desc "Update JSON template on AWS"
long_desc "Update a stack with a pre-generated JSON template. You'll probably want to specify a policy to override the default."
command :update do |c|
  c.flag [:policy]
  c.flag [:stackname], :required => true
  c.switch [:y]
  c.action do |globals, options, args|
    help_now!("Wrong number of arguments for build") unless args.length == 2
    s = Spaceape::Cloudformation::Uploader.new(*args)
    s.update_stack(options)
  end
end

exit run(ARGV)
